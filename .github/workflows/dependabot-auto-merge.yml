name: Dependabot Auto-merge

on: pull_request

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # DependabotãŒä½œæˆã—ãŸPRã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2.5.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-approve for patch and minor updates
        # ãƒ‘ãƒƒãƒã¨ãƒã‚¤ãƒŠãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è‡ªå‹•æ‰¿èªï¼ˆå…ˆã«æ‰¿èªãŒå¿…è¦ï¼‰
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for patch and minor updates
        # ãƒ‘ãƒƒãƒã¨ãƒã‚¤ãƒŠãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ã¿è‡ªå‹•ãƒãƒ¼ã‚¸
        # ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¯æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        # ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¯æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¿ƒã™ã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "ğŸš¨ **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ¤œå‡º**

          ã“ã®PRã¯ç ´å£Šçš„å¤‰æ›´ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
          æ‰‹å‹•ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

          - å¤‰æ›´å†…å®¹: ${{ steps.metadata.outputs.dependency-names }}
          - æ›´æ–°ã‚¿ã‚¤ãƒ—: Major version update"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
